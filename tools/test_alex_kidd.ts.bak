import { readFileSync, writeFileSync, existsSync } from 'fs';
import { createMachine } from '../machine/machine.js';
import type { Cartridge } from '../bus/bus.js';
import { generatePNG } from '../../scripts/generate_png.js';

const romFile = './Alex Kidd - The Lost Stars (UE) [!].sms';

if (!existsSync(romFile)) {
  console.error(`ROM file not found: ${romFile}`);
  process.exit(1);
}

console.log('=== Testing Alex Kidd - The Lost Stars ===\n');

const rom = new Uint8Array(readFileSync(romFile));
console.log(`ROM size: ${rom.length} bytes (${rom.length / 1024}KB)`);

// Check header
console.log('\nROM Header at 0x7FF0:');
const header = rom.subarray(0x7FF0, 0x8000);
let headerStr = '';
for (let i = 0; i < 16; i++) {
  const c = header[i]!;
  headerStr += (c >= 32 && c < 127) ? String.fromCharCode(c) : '.';
}
console.log('Text:', headerStr);

// Create machine
const cart: Cartridge = { rom };
const m = createMachine({ cart, fastBlocks: true });

// Run for several frames
console.log('\nRunning emulator for 60 frames...');
const vdp = m.getVDP();
const cyclesPerFrame = 59736; // NTSC

for (let frame = 0; frame < 60; frame++) {
  m.runCycles(cyclesPerFrame);
  
  if (frame === 0 || frame === 29 || frame === 59) {
    const cpu = m.getCPU();
    const bus = m.getBus();
    const vdpState = vdp.getState ? vdp.getState() : undefined;
    
    console.log(`\n--- Frame ${frame + 1} ---`);
    const cpuSt = cpu.getState();
    console.log(`PC: 0x${cpuSt.pc.toString(16).padStart(4, '0')}`);
    console.log(`Display: ${(vdpState?.regs[1] ?? 0) & 0x40 ? 'ON' : 'OFF'}`);
    console.log(`VDP regs: ${vdpState?.regs.slice(0, 11).map(r => r.toString(16).padStart(2, '0')).join(' ')}`);
    
    // Count VRAM/CRAM activity
    const stats = bus.getVDPWriteStats();
    console.log(`VDP writes - Data: ${stats.data}, Control: ${stats.control}`);
  }
}

// Generate screenshot
console.log('\nGenerating screenshot...');
const vram = vdp.getVRAM();
const cram = vdp.getCRAM();
const vdpSt = vdp.getState();
const regs = vdpSt ? vdpSt.regs : new Uint8Array(16);

const pngData = generatePNG({
  vram,
  cram,
  regs,
  mode: 'either',
  sourceKey: 'alex_kidd',
});

writeFileSync('alex_kidd_frame.png', pngData.buffer);
console.log(`Wrote alex_kidd_frame.png (${pngData.width}x${pngData.height})`);
console.log(`Source: ${pngData.source}`);

// Diagnostic info
const cpu = m.getCPU();
const bus = m.getBus();
const vdpState = vdp.getState ? vdp.getState() : undefined;
const stats = bus.getVDPWriteStats();
const cpuState = cpu.getState();
const finalState = {
  lastPC: `0x${cpuState.pc.toString(16).padStart(4, '0')}`,
  irqsAccepted: cpu.getIrqCount(),
  nmisAccepted: cpu.getNmiCount(),
  displayEnabled: ((vdpState?.regs[1] ?? 0) & 0x40) !== 0,
  vblankIrqEnabled: ((vdpState?.regs[1] ?? 0) & 0x20) !== 0,
  nameTableBase: `0x${((vdpState?.regs[2] ?? 0) & 0x0e) << 10}`.padStart(4, '0'),
};

console.log('\n=== Final State ===');
console.log(JSON.stringify(finalState, null, 2));

// Check if game is progressing
if (finalState.displayEnabled && stats.data > 1000) {
  console.log('\n✅ Game appears to be running! Display is on and VRAM has been written.');
} else if (cpuState.pc < 0x100) {
  console.log('\n⚠️ Game might be stuck in early initialization.');
} else {
  console.log('\n⚠️ Game status unclear. Check the generated PNG for visual output.');
}
